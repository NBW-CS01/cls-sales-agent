# NDA Mail-Merge Implementation Guide

## Overview

The NDA generation system performs a **mail-merge** operation that:
1. Fetches company data from **Companies House API**
2. Replaces placeholder fields in the **NDA template** with real data
3. Generates a completed NDA document

## How It Works

### User Interaction with Sales Agent

```
User: "Generate an NDA for company SC123456, signatory Patrick Godden, Director"

Jamie (Bedrock Agent):
  ↓ Calls NDA Generator Lambda function
  ↓ Parameters: company_identifier="SC123456", signatory_name="Patrick Godden", signatory_title="Director"
```

### Process Flow

```
┌─────────────────────────────────────────────────────────────┐
│ 1. FETCH FROM COMPANIES HOUSE                               │
│    Input: SC123456                                          │
│    Output:                                                  │
│      - Company Name: "Example Scotland Ltd"                 │
│      - Company Number: "SC123456"                           │
│      - Company Type: "Private Limited Company"              │
│      - Jurisdiction: "Scotland"                             │
│      - Registered Address: "123 High St, Edinburgh..."      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. LOAD NDA TEMPLATE FROM S3                                │
│    Template: "Non-Disclosure Agreement Template v01..."     │
│    Contains placeholders:                                   │
│      [Date], [Recipient Name], [Company Type],              │
│      [Jurisdiction], [Company Number],                      │
│      [Registered Address], [Name], [Title]                  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. MAIL-MERGE: REPLACE PLACEHOLDERS                         │
│    [Date]                 → 06 November 2025                │
│    [Recipient Name]       → Example Scotland Ltd            │
│    [Recipient]            → Example Scotland Ltd            │
│    [Company Type]         → Private Limited Company         │
│    [Jurisdiction]         → Scotland                        │
│    [Company Number]       → SC123456                        │
│    [Registered Address]   → 123 High St, Edinburgh...       │
│    [Name]                 → Patrick Godden                  │
│    [Title]                → Director                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. SAVE TO S3 & RETURN DOWNLOAD LINK                        │
│    Path: s3://bucket/generated-ndas/NDA_Example_Scotland... │
│    URL: https://s3.../NDA_Example_Scotland_Ltd_20251106.... │
└─────────────────────────────────────────────────────────────┘
```

## Template Fields Explained

### From Companies House API

| Template Field        | Data Source                          | Example Value                        |
|-----------------------|--------------------------------------|--------------------------------------|
| `[Recipient Name]`    | Companies House: company_name        | "Example Scotland Ltd"               |
| `[Recipient]`         | Companies House: company_name        | "Example Scotland Ltd"               |
| `[Company Number]`    | Companies House: company_number      | "SC123456"                           |
| `[Company Type]`      | Inferred from prefix + API           | "Private Limited Company"            |
| `[Jurisdiction]`      | Inferred from prefix                 | "Scotland" (SC prefix)               |
| `[Registered Address]`| Companies House: registered_office   | "123 High St, Edinburgh, EH1 1AA"    |

### From User Input

| Template Field | User Provides      | Example Value      |
|----------------|--------------------|--------------------|
| `[Name]`       | Signatory name     | "Patrick Godden"   |
| `[Title]`      | Signatory title    | "Director"         |

### Auto-Generated

| Template Field | Generated By       | Example Value        |
|----------------|--------------------|----------------------|
| `[Date]`       | Current date (UTC) | "06 November 2025"   |

## Company Number Prefix Intelligence

The system automatically infers **jurisdiction** and **company type** from the company number prefix:

### Jurisdiction Inference

| Prefix | Jurisdiction        | Example        |
|--------|---------------------|----------------|
| SC     | Scotland            | SC123456       |
| NI     | Northern Ireland    | NI123456       |
| (none) | England and Wales   | 01234567       |

### Company Type Inference

| Prefix | Company Type                    | Example        |
|--------|---------------------------------|----------------|
| (none) | Private Limited Company         | 01234567       |
| SC     | Private Limited Company         | SC123456       |
| OC     | Limited Liability Partnership   | OC123456       |
| LP     | Limited Partnership             | LP123456       |
| SO     | Scottish LLP                    | SO123456       |

Full mapping available in `lambda/companies_house.py` (30+ prefix types)

## Example: Before and After

### Template (Before Mail-Merge)

```
NON-DISCLOSURE AGREEMENT

This Non-Disclosure Agreement ("Agreement") is made as of [Date]
("Effective Date") between Cloudscaler Limited, a company registered
in England and Wales with company number 11515460, whose registered
office is at 46–54 High Street, Ingatestone, Essex, CM4 9DW ("Cloudscaler")
and [Recipient Name], a [Company Type] registered in [Jurisdiction]
with company number [Company Number], whose registered office is at
[Registered Address] ("Recipient").

...

Signed by [Name], [Title] of [Recipient Name]
```

### Generated Document (After Mail-Merge)

```
NON-DISCLOSURE AGREEMENT

This Non-Disclosure Agreement ("Agreement") is made as of 06 November 2025
("Effective Date") between Cloudscaler Limited, a company registered
in England and Wales with company number 11515460, whose registered
office is at 46–54 High Street, Ingatestone, Essex, CM4 9DW ("Cloudscaler")
and Example Scotland Ltd, a Private Limited Company registered in Scotland
with company number SC123456, whose registered office is at
123 High Street, Edinburgh, EH1 1AA ("Recipient").

...

Signed by Patrick Godden, Director of Example Scotland Ltd
```

## Code Implementation

The mail-merge logic is in `/lambda/nda_generator.py`:

```python
def populate_nda_template(template_content, company_data, signatory_name, signatory_title):
    # Load Word document
    doc = Document(io.BytesIO(template_content))

    # Build replacement dictionary matching exact template fields
    replacements = {
        '[Date]': datetime.utcnow().strftime('%d %B %Y'),
        '[Recipient Name]': company_data['company_name'],
        '[Recipient]': company_data['company_name'],
        '[Company Type]': company_data['company_type'],
        '[Jurisdiction]': company_data['jurisdiction'],
        '[Company Number]': company_data['company_number'],
        '[Registered Address]': company_data['registered_office_address'],
        '[Name]': signatory_name,
        '[Title]': signatory_title,
    }

    # Replace in paragraphs
    for paragraph in doc.paragraphs:
        for key, value in replacements.items():
            if key in paragraph.text:
                for run in paragraph.runs:
                    if key in run.text:
                        run.text = run.text.replace(key, value)

    # Replace in tables (same logic)
    for table in doc.tables:
        for row in table.rows:
            for cell in row.cells:
                # ... replacement logic

    return doc_as_bytes
```

## Sales Agent Interaction

### Example Conversation

```
User: "I need an NDA for Scottish company SC234567, signatory is
       Sharona Rollnick who is the Managing Director"

Jamie: I'll generate an NDA for SC234567. Let me fetch the company
       details from Companies House...

       [Calls NDA Generator Lambda with:
        - company_identifier: "SC234567"
        - signatory_name: "Sharona Rollnick"
        - signatory_title: "Managing Director"]

Jamie: ✓ NDA generated successfully!

       Company: Highland Ventures Ltd
       Number: SC234567
       Type: Private Limited Company
       Jurisdiction: Scotland
       Address: 45 Royal Mile, Edinburgh, EH1 2PB

       Signatory: Sharona Rollnick, Managing Director

       Download: https://s3.../NDA_Highland_Ventures_Ltd_20251106.docx
       (Link expires in 1 hour)
```

## What Makes This a "Mail-Merge"

Traditional mail-merge (e.g., Word Mail Merge):
- Template with placeholder fields
- Data source (Excel, CSV, database)
- Merge process creates personalized documents

This implementation:
- ✓ Template: NDA Word document with `[Field]` placeholders
- ✓ Data source: Companies House API (live, always up-to-date)
- ✓ Merge process: Python docx library replaces fields
- ✓ Output: Personalized NDA for each company

**Advantages over manual mail-merge:**
1. No manual data entry needed
2. Always uses latest company data from official source
3. Automatic jurisdiction/type inference from company number
4. Integrated with AI sales agent (conversational interface)
5. Stored securely in S3 with audit trail

## Testing Locally

To test the mail-merge process:

```bash
cd /Users/nick.barton-wells/Projects/cls-sales-agent
python3 test_nda_generation.py
```

This will:
1. Prompt for company number
2. Fetch from Companies House
3. Show the field mappings
4. Display before/after preview

## Next Steps

1. **Deploy Infrastructure**: Run `./deploy-jamie.sh` to deploy Lambda functions
2. **Upload Template**: Template goes to `s3://bucket/templates/`
3. **Test via Agent**: Use jamie-cli.py to test conversational NDA generation
4. **Review Generated NDAs**: Check `s3://bucket/generated-ndas/`

---

**Last Updated**: 2025-11-06
**Users**: Patrick Godden, Sharona Rollnick
**Reviewer**: Jamie Collingwood
